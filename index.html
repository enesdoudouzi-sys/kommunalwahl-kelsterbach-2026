// ===============================
// Kelsterbach – Stimmungsbild
// Frontend + Backend in EINEM File
// ===============================

import express from "express";
import sqlite3 from "sqlite3";
import crypto from "crypto";

const app = express();
app.use(express.json());

/* ===============================
   DATABASE
================================ */
const db = new sqlite3.Database("./db.sqlite");

db.run(`
CREATE TABLE IF NOT EXISTS votes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  choice TEXT NOT NULL,
  hash TEXT NOT NULL,
  created_at INTEGER NOT NULL
)`);

db.run(`
CREATE TABLE IF NOT EXISTS themes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  theme TEXT NOT NULL,
  hash TEXT NOT NULL,
  created_at INTEGER NOT NULL
)`);

/* ===============================
   HELPERS
================================ */
function makeHash(req){
  return crypto
    .createHash("sha256")
    .update(req.ip + req.headers["user-agent"])
    .digest("hex");
}

/* ===============================
   API
================================ */
app.post("/api/vote",(req,res)=>{
  const { choice } = req.body;
  if(!choice) return res.status(400).end();

  const hash = makeHash(req);
  const since = Date.now() - 24*60*60*1000;

  db.get(
    "SELECT id FROM votes WHERE hash=? AND created_at>?",
    [hash,since],
    (err,row)=>{
      if(row) return res.status(429).json({error:"already voted"});
      db.run(
        "INSERT INTO votes (choice,hash,created_at) VALUES (?,?,?)",
        [choice,hash,Date.now()],
        ()=>res.json({ok:true})
      );
    }
  );
});

app.get("/api/results",(req,res)=>{
  db.all(
    "SELECT choice, COUNT(*) as count FROM votes GROUP BY choice",
    (err,rows)=>res.json(rows)
  );
});

app.post("/api/themes",(req,res)=>{
  const { themes } = req.body;
  if(!Array.isArray(themes)) return res.status(400).end();

  const hash = makeHash(req);
  const now = Date.now();
  const stmt = db.prepare(
    "INSERT INTO themes (theme,hash,created_at) VALUES (?,?,?)"
  );
  themes.forEach(t=>stmt.run(t,hash,now));
  stmt.finalize(()=>res.json({ok:true}));
});

app.get("/api/themes",(req,res)=>{
  db.all(
    "SELECT theme, COUNT(*) as count FROM themes GROUP BY theme ORDER BY count DESC",
    (err,rows)=>res.json(rows)
  );
});

/* ===============================
   FRONTEND (HTML)
================================ */
app.get("/",(req,res)=>{
res.send(`<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Kommunalwahl Kelsterbach – Stimmungsbild</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:system-ui;margin:2rem;background:#f6f8fb}
section{background:#fff;padding:1.5rem;border-radius:16px;margin-bottom:1.5rem}
label{display:block;padding:.5rem}
button{margin-top:1rem;padding:.6rem 1.2rem}
.bar{height:14px;background:#2563eb;border-radius:999px}
.small{font-size:.85rem;color:#555}
</style>
</head>
<body>

<h1>Kommunalwahl Kelsterbach</h1>
<p class="small">Neutrales, anonymes Stimmungsbild</p>

<section>
<form id="voteForm">
<label><input type="radio" name="vote" value="CDU"> CDU</label>
<label><input type="radio" name="vote" value="SPD"> SPD</label>
<label><input type="radio" name="vote" value="FDP"> FDP</label>
<label><input type="radio" name="vote" value="Die Linke"> Die Linke</label>
<label><input type="radio" name="vote" value="EUK"> EUK</label>
<label><input type="radio" name="vote" value="Freie Wähler"> Freie Wähler</label>
<label><input type="radio" name="vote" value="WIK + FNK"> WIK + FNK</label>
<label><input type="radio" name="vote" value="HAK"> HAK</label>
<label><input type="radio" name="vote" value="Unentschlossen"> Unentschlossen</label>
<button>Stimme abgeben</button>
</form>
</section>

<section>
<h2>Ergebnis</h2>
<div id="results"></div>
</section>

<section>
<h2>Themen</h2>
<form id="themesForm">
<label><input type="checkbox" value="Wohnraum"> Wohnraum</label>
<label><input type="checkbox" value="Verkehr"> Verkehr</label>
<label><input type="checkbox" value="Radwege"> Radwege</label>
<label><input type="checkbox" value="ÖPNV"> ÖPNV</label>
<button>Themen speichern</button>
</form>
<div id="themeResults" class="small"></div>
</section>

<script>
const parteien=["CDU","SPD","FDP","Die Linke","EUK","Freie Wähler","WIK + FNK","HAK","Unentschlossen"];

document.getElementById("voteForm").onsubmit=async e=>{
  e.preventDefault();
  const c=document.querySelector("input[name=vote]:checked");
  if(!c) return;
  const r=await fetch("/api/vote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({choice:c.value})});
  if(r.status===429) alert("Schon abgestimmt");
  anzeigen();
};

document.getElementById("themesForm").onsubmit=async e=>{
  e.preventDefault();
  const themes=[...document.querySelectorAll("#themesForm input:checked")].map(x=>x.value);
  await fetch("/api/themes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({themes})});
  showThemes();
};

async function anzeigen(){
  const r=await fetch("/api/results");
  const rows=await r.json();
  const map={};parteien.forEach(p=>map[p]=0);
  rows.forEach(r=>map[r.choice]=r.count);
  const sum=Object.values(map).reduce((a,b)=>a+b,0);
  const d=document.getElementById("results");d.innerHTML="";
  parteien.forEach(p=>{
    const v=map[p],pc=sum?(v/sum*100).toFixed(1):0;
    d.innerHTML+=\`<div><b>\${p}: \${pc}% (\${v})</b><div class="bar" style="width:\${pc}%"></div></div>\`;
  });
}

async function showThemes(){
  const r=await fetch("/api/themes");
  const rows=await r.json();
  document.getElementById("themeResults").innerHTML=
    rows.map(r=>\`\${r.theme}: \${r.count}\`).join("<br>");
}

anzeigen();showThemes();
</script>
</body>
</html>`);
});

/* ===============================
   START
================================ */
app.listen(3000,()=>console.log("Läuft auf http://localhost:3000"));
